
'use client';

import { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Loader2, ArrowLeft } from 'lucide-react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import AppFrameLayout from '@/components/layout/app-frame';
import { useToast } from '@/hooks/use-toast';
import { collection, getDocs, addDoc, query, where } from 'firebase/firestore';
import { db } from '@/lib/firebase';
import { manageWalkInQueue } from '@/ai/flows/walk-in-queue-management';
import { format } from 'date-fns';
import type { Appointment, Doctor, Patient } from '@/lib/types';


const formSchema = z.object({
  name: z.string().min(2, { message: "Name must be at least 2 characters." }),
  age: z.coerce.number().int().positive({ message: "Age must be a positive number." }).min(1, { message: "Please enter a valid age." }),
  phone: z.string().min(10, { message: "Please enter a valid phone number."}),
  location: z.string().min(2, { message: "Location is required." }),
  gender: z.string().min(1, { message: "Gender is required." }),
  department: z.string().min(1, { message: "Department is required." }),
  doctor: z.string().min(1, { message: "Doctor is required." }),
  treatment: z.string().optional(),
});

export default function WalkInRegistrationPage() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const doctorId = searchParams.get('doctor');
    const { toast } = useToast();
    const [isProcessing, setIsProcessing] = useState(false);
    const [doctors, setDoctors] = useState<Doctor[]>([]);
    const [departments, setDepartments] = useState<{id: string, name: string}[]>([]);
    const [appointments, setAppointments] = useState<Appointment[]>([]);

    const form = useForm<z.infer<typeof formSchema>>({
        resolver: zodResolver(formSchema),
        defaultValues: {
          name: '',
          age: undefined,
          location: '',
          phone: '',
          gender: '',
          department: '',
          doctor: '',
          treatment: '',
        },
      });

    useEffect(() => {
        const fetchInitialData = async () => {
          try {
            const doctorsCollection = collection(db, 'doctors');
            const doctorsSnapshot = await getDocs(doctorsCollection);
            const fetchedDoctors = doctorsSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() })) as Doctor[];
            setDoctors(fetchedDoctors);
    
            const departmentsCollection = collection(db, 'departments');
            const departmentsSnapshot = await getDocs(departmentsCollection);
            const fetchedDepts = departmentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() as {name: string} }));
            setDepartments(fetchedDepts);

            const appointmentsCollection = collection(db, 'appointments');
            const appointmentsSnapshot = await getDocs(appointmentsCollection);
            const fetchedAppointments = appointmentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data()})) as Appointment[];
            setAppointments(fetchedAppointments);

            if (doctorId && fetchedDoctors.length > 0) {
                const selectedDoc = fetchedDoctors.find(d => d.id === doctorId);
                if (selectedDoc) {
                    form.setValue('doctor', selectedDoc.name);
                    form.setValue('department', selectedDoc.department);
                }
            }
    
          } catch (error) {
            console.error('Error fetching initial data:', error);
            toast({
              variant: 'destructive',
              title: 'Error',
              description: 'Could not fetch required data. Please try again.',
            });
          }
        };
        fetchInitialData();
    }, [toast, doctorId, form]);


  const onSubmit = async (values: z.infer<typeof formSchema>) => {
    setIsProcessing(true);
    try {
        const { name, age, location, gender, phone, ...appointmentDetails } = values;
        const patient: Patient = { name, age, location, gender, phone };

        const onlineAppointments = appointments.filter((a) => a.bookedVia === 'online');
        const lastAppointment = appointments.sort((a, b) => (b.numericToken || 0) - (a.numericToken || 0))[0];
        const lastToken = lastAppointment ? lastAppointment.numericToken : 0;


      const { walkInPatientToken } = await manageWalkInQueue({
        walkInPatientName: patient.name,
        walkInPatientAge: patient.age,
        walkInPatientLocation: patient.location,
        lastOnlineAppointmentToken: lastToken,
        numberOfOnlineAppointments: onlineAppointments.length,
      });

      const today = format(new Date(), 'd MMMM yyyy');
        const q = query(
            collection(db, 'appointments'),
            where('date', '==', today),
            where('bookedVia', '==', 'Walk-in')
        );
      const walkInAppointmentsTodaySnapshot = await getDocs(q);
      const walkInCount = walkInAppointmentsTodaySnapshot.size + 1;
      
      const newWalkIn = {
        ...patient,
        ...appointmentDetails,
        patientName: name,
        patientDetails: patient,
        age: patient.age,
        place: patient.location,
        bookedVia: "Walk-in",
        date: format(new Date(), 'd MMMM yyyy'),
        status: "Pending",
        time: format(new Date(), 'hh:mm a'),
        tokenNumber: `W${walkInCount.toString().padStart(3, '0')}`,
        numericToken: walkInPatientToken,
      };

      await addDoc(collection(db, "appointments"), newWalkIn);

      toast({
        title: 'Success',
        description: `Patient ${patient.name} added with token ${newWalkIn.tokenNumber}.`,
      });
      router.push('/dashboard');
    } catch (error) {
      console.error('Failed to add walk-in patient:', error);
      toast({
        variant: 'destructive',
        title: 'Error',
        description: 'Could not add walk-in patient. Please try again.',
      });
    } finally {
      setIsProcessing(false);
    }
  }

  return (
    <AppFrameLayout>
        <div className="flex flex-col h-full">
            <header className="flex items-center gap-4 p-4 border-b">
                <Link href="/">
                    <Button variant="ghost" size="icon">
                        <ArrowLeft />
                    </Button>
                </Link>
                <div className="flex-1">
                    <h1 className="text-xl font-bold">Register Walk-in Patient</h1>
                    <p className="text-sm text-muted-foreground">
                        Fill details to add a patient to the queue.
                    </p>
                </div>
            </header>
            <div className="p-6 overflow-y-auto flex-1">
                <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                        <FormField
                            control={form.control}
                            name="name"
                            render={({ field }) => (
                            <FormItem>
                                <FormLabel>Full Name</FormLabel>
                                <FormControl>
                                <Input placeholder="e.g. John Doe" {...field} />
                                </FormControl>
                                <FormMessage />
                            </FormItem>
                            )}
                        />
                        <FormField
                            control={form.control}
                            name="age"
                            render={({ field }) => (
                            <FormItem>
                                <FormLabel>Age</FormLabel>
                                <FormControl>
                                <Input type="number" placeholder="e.g. 42" {...field} />
                                </FormControl>
                                <FormMessage />
                            </FormItem>
                            )}
                        />
                        <FormField
                            control={form.control}
                            name="phone"
                            render={({ field }) => (
                            <FormItem>
                                <FormLabel>Phone Number</FormLabel>
                                <FormControl>
                                <Input type="tel" placeholder="e.g. 555-123-4567" {...field} />
                                </FormControl>
                                <FormMessage />
                            </FormItem>
                            )}
                        />
                        <FormField
                            control={form.control}
                            name="location"
                            render={({ field }) => (
                            <FormItem>
                                <FormLabel>City / Location</FormLabel>
                                <FormControl>
                                <Input placeholder="e.g. Springfield" {...field} />
                                </FormControl>
                                <FormMessage />
                            </FormItem>
                            )}
                        />
                        <FormField
                            control={form.control}
                            name="gender"
                            render={({ field }) => (
                            <FormItem>
                                <FormLabel>Gender</FormLabel>
                                <Select onValueChange={field.onChange} defaultValue={field.value}>
                                    <FormControl>
                                        <SelectTrigger>
                                        <SelectValue placeholder="Select gender" />
                                        </SelectTrigger>
                                    </FormControl>
                                    <SelectContent>
                                        <SelectItem value="Male">Male</SelectItem>
                                        <SelectItem value="Female">Female</SelectItem>
                                        <SelectItem value="Other">Other</SelectItem>
                                    </SelectContent>
                                </Select>
                                <FormMessage />
                            </FormItem>
                            )}
                        />
                        <FormField
                            control={form.control}
                            name="department"
                            render={({ field }) => (
                                <FormItem>
                                <FormLabel>Department</FormLabel>
                                <Select 
                                    onValueChange={(value) => {
                                        field.onChange(value);
                                        const doctorInNewDept = doctors.find(d => d.department === value);
                                        form.setValue('doctor', doctorInNewDept ? doctorInNewDept.name : '');
                                    }}
                                    value={field.value}
                                >
                                    <FormControl>
                                        <SelectTrigger>
                                        <SelectValue placeholder="Select department" />
                                        </Trigger>
                                    </FormControl>
                                    <SelectContent>
                                        {departments.map(dept => <SelectItem key={dept.id} value={dept.name}>{dept.name}</SelectItem>)}
                                    </SelectContent>
                                </Select>
                                <FormMessage />
                                </FormItem>
                            )}
                            />
                        <FormField
                            control={form.control}
                            name="doctor"
                            render={({ field }) => (
                                <FormItem>
                                <FormLabel>Doctor</FormLabel>
                                <Select onValueChange={field.onChange} value={field.value}>
                                    <FormControl>
                                        <SelectTrigger>
                                        <SelectValue placeholder="Select doctor" />
                                        </Trigger>
                                    </FormControl>
                                    <SelectContent>
                                        {doctors.filter(d => d.department === form.watch('department')).map(doc => (
                                            <SelectItem key={doc.id} value={doc.name}>Dr. {doc.name}</SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                                <FormMessage />
                                </FormItem>
                            )}
                        />
                        <FormField
                            control={form.control}
                            name="treatment"
                            render={({ field }) => (
                            <FormItem>
                                <FormLabel>Reason for Visit</FormLabel>
                                <FormControl>
                                <Textarea placeholder="e.g. Annual check-up, fever..." {...field} />
                                </FormControl>
                                <FormMessage />
                            </FormItem>
                            )}
                        />
                        <Button type="submit" className="w-full mt-6" disabled={isProcessing}>
                            {isProcessing ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Adding Patient...
                            </>
                            ) : (
                            'Add Patient'
                            )}
                        </Button>
                    </form>
                </Form>
          </div>
        </div>
    </AppFrameLayout>
  );
}
