<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Backend Documentation</title><link rel="stylesheet" href="../assets/css/documentation.css"></head><body><header class="header"><div class="header-content"><h1>üõ†Ô∏è Backend</h1><nav class="header-nav"><a href="../index.html">Home</a></nav></div></header><div class="container"><aside class="sidebar"><h3>Sections</h3><ul><li><a href="#services">Service layer</a></li><li><a href="#middleware">Middleware/transactions</a></li><li><a href="#jobs">Background tasks</a></li><li><a href="#files">File handling</a></li><li><a href="#notifications">Notifications</a></li><li><a href="#logging">Logging/monitoring</a></li></ul></aside><main class="main-content"><div class="breadcrumbs"><a href="../index.html">Home</a> <span>/</span> Backend</div>
<h2 id="services">Service Layer (shared-core)</h2><ul><li><strong>appointment-service:</strong> advanced booking, token counters, slot reservations, rebalance when walk-ins inserted.</li><li><strong>walk-in.service / walk-in-booking:</strong> computes placement, spacing rules, bucket slots.</li><li><strong>queue-management-service:</strong> queue snapshots, buffer queue, skipped token rejoin.</li><li><strong>status-update-service:</strong> periodic status updates (Pending‚ÜíSkipped, Skipped‚ÜíNo-show).</li><li><strong>notification-service:</strong> FCM push; resolves patient‚Üíuser; non-blocking failures.</li><li><strong>capacity-service:</strong> 85/15 split helpers.</li></ul>

<h2 id="middleware">Transactions & Safety</h2><ul><li>Use Firestore `runTransaction` for token-counters and slot-reservations.</li><li>Reservation conflict code `slot-reservation-conflict` handled in appointment-service.</li><li>Atomic writes to appointments + counters to prevent double booking.</li></ul>

<h2 id="jobs">Background/Periodic</h2><ul><li>Status updater invoked on app open or scheduled: `updateAppointmentAndDoctorStatuses(clinicId)`.</li><li>Rebalance walk-ins may be triggered after inserts.</li></ul>

<h2 id="files">File Upload/Download</h2><ul><li>Upload avatar: `clinic-admin/api/upload-avatar` uses Firebase Admin Storage with `GOOGLE_SERVICE_ACCOUNT_JSON`; makes file public.</li><li>Upload clinic document: similar pattern under `upload-clinic-document` route.</li></ul>

<h2 id="notifications">Notifications & Messaging</h2><ul><li>FCM via `notification-service`; frontend helper route `patient-app/api/send-notification` used by service.</li><li>Twilio SMS/WhatsApp via `clinic-admin/api/send-sms` using `TWILIO_*` env.</li></ul>

<h2 id="logging">Logging & Monitoring</h2><ul><li>Logger in `shared-core/lib/logger.ts` (console-based).</li><li>Error boundaries in each app (`components/ErrorBoundary.tsx`).</li><li>Consider adding Sentry/LogRocket for production (not present).</li></ul>
<div class="alert alert-info">Always call shared-core services from app code; avoid duplicating booking logic in components.</div>
</main></div><footer class="footer"><p>Kloqo Technical Documentation ¬© 2024</p></footer><a href="#top" id="back-to-top" class="back-to-top">‚Üë</a><script src="../assets/js/navigation.js"></script></body></html>